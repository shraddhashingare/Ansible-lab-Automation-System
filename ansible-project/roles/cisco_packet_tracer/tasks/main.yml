---
- name: Check if Packet Tracer is already installed
  win_stat:
    path: "C:\\Program Files\\Cisco Packet Tracer 6.2\\bin\\PacketTracer.exe"
  register: pt_installed

- name: Skip installation if Packet Tracer already installed
  debug:
    msg: "Packet Tracer already installed â€” skipping."
  when: pt_installed.stat.exists


# ---------------------------------------------------
# CHECK IF INSTALLER EXISTS IN DOWNLOADS
# ---------------------------------------------------
- name: Check if installer already exists in Downloads
  win_stat:
    path: "C:\\Users\\{{ ansible_user }}\\Downloads\\PacketTracer62_setup.exe"
  register: exe_exists
  when: not pt_installed.stat.exists


# ---------------------------------------------------
# COPY EXE ONLY IF NOT PRESENT
# ---------------------------------------------------
- name: Copy installer to Downloads (only if absent)
  win_copy:
    src: PacketTracer62_setup.exe
    dest: "C:\\Users\\{{ ansible_user }}\\Downloads\\PacketTracer62_setup.exe"
    force: no
  when:
    - not pt_installed.stat.exists
    - not exe_exists.stat.exists


# ---------------------------------------------------
# CLEAR PREVIOUS STUCK INSTALLATION PROCESSES
# ---------------------------------------------------
- name: Kill any stuck Packet Tracer installer process
  win_shell: |
    Get-Process -Name PacketTracer62_setup -ErrorAction SilentlyContinue | Stop-Process -Force
  ignore_errors: yes
  when: not pt_installed.stat.exists


# ---------------------------------------------------
# DELETE OLD LOG FILE
# ---------------------------------------------------
- name: Remove old installation log
  win_file:
    path: "C:\\Users\\{{ ansible_user }}\\Downloads\\pt_install_test.log"
    state: absent
  when: not pt_installed.stat.exists


# ---------------------------------------------------
# RUN INSTALLATION
# ---------------------------------------------------
- name: Run Packet Tracer silent installer
  win_command: >
    C:\Users\{{ ansible_user }}\Downloads\PacketTracer62_setup.exe
    /VERYSILENT /NORESTART
    /LOG="C:\Users\{{ ansible_user }}\Downloads\pt_install_test.log"
  async: 1800
  poll: 5
  register: install_output
  when: not pt_installed.stat.exists


# ---------------------------------------------------
# CHECK IF INSTALL LOG SHOWS SUCCESS
# ---------------------------------------------------
- name: Verify installation success
  win_shell: |
    Select-String -Path "C:\Users\{{ ansible_user }}\Downloads\pt_install_test.log" -Pattern "Installation process succeeded" | Measure-Object | %{$_.Count}
  register: install_success
  when: not pt_installed.stat.exists


# ---------------------------------------------------
# FAIL IF FAILED
# ---------------------------------------------------
- name: Fail if installation failed
  fail:
    msg: "Installation failed! Check log in Downloads folder."
  when:
    - not pt_installed.stat.exists
    - install_success.stdout | int == 0


# ---------------------------------------------------
# SUCCESS MESSAGE
# ---------------------------------------------------
- name: Show success message
  debug:
    msg: "Cisco Packet Tracer installation completed successfully!"
  when: not pt_installed.stat.exists
