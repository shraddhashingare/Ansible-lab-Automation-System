---
- name: Check if Packet Tracer is already installed
  win_stat:
    path: "C:\\Program Files\\Cisco Packet Tracer 6.2\\bin\\PacketTracer.exe"
  register: pt_installed

- name: Skip installation if Packet Tracer already exists
  debug:
    msg: "Packet Tracer already installed â€” skipping installation."
  when: pt_installed.stat.exists

- name: Kill any stuck Packet Tracer installer process
  win_shell: |
    Get-Process -Name PacketTracer62_setup -ErrorAction SilentlyContinue | Stop-Process -Force
  ignore_errors: yes
  when: not pt_installed.stat.exists

- name: Ensure installer directory exists
  win_file:
    path: C:\Installers
    state: directory
  when: not pt_installed.stat.exists

- name: Copy Packet Tracer 6.2 installer to PC
  win_copy:
    src: PacketTracer62_setup.exe
    dest: C:\Installers\PacketTracer62_setup.exe
    force: yes
  when: not pt_installed.stat.exists

- name: Remove any previous log file
  win_file:
    path: C:\Installers\pt_install_test.log
    state: absent
  when: not pt_installed.stat.exists

- name: Run Packet Tracer silent installer (async)
  win_command: >
    C:\Installers\PacketTracer62_setup.exe /VERYSILENT /NORESTART /LOG="C:\Installers\pt_install_test.log"
  async: 1800
  poll: 5
  register: silent_result
  when: not pt_installed.stat.exists

- name: Verify "Installation process succeeded" in log
  win_shell: |
    Select-String -Path "C:\Installers\pt_install_test.log" -Pattern "Installation process succeeded" | Measure-Object | %{$_.Count}
  register: install_success
  when: not pt_installed.stat.exists

- name: Fail if installation was not successful
  fail:
    msg: "Packet Tracer installation failed. Check C:\\Installers\\pt_install_test.log."
  when: 
    - not pt_installed.stat.exists
    - install_success.stdout | int == 0

- name: Show success message
  debug:
    msg: "Packet Tracer installed successfully!"
  when:
    - not pt_installed.stat.exists

